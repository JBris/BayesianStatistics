# observed data
gss = list(
  n = 550, 
  y = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
        1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 12, 12, 
        12, 12, 12, 12, 13, 13, 13, 15, 15, 15, 16, 16, 16, 20, 20, 20, 20, 20, 20, 20, 24, 25, 30, 30, 30, 50, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 13, 13, 13, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 16, 17, 18, 20, 20, 20, 20, 20, 20, 22, 23, 25, 25, 25, 27, 30), 
  gender = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
             0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
)

# zero-inflated negative binomial glm model
zinb_glm_code = "
data {
  int<lower=1> n;  // number of observations
  int y[n];  // count of sexual intercourse in previous month
  int<lower=0, upper=1> gender[n];  // male = 0, female = 1
}
parameters {
  vector[2] p0; //vector of excess zero probabilities
  vector[2] beta; //related to mean of negative binomial
  vector[2] r; //related to dispersion of negative binomial
}
transformed parameters {
  vector[n] lambda;
  for(i in 1:n) {
    // mean of negative binomial
    lambda[i] = exp(beta[1] + beta[2] * gender[i]) ;
  }
}
model {
  // prior distributions
  // different parameter for each gender
  for (j in 1:2) {
    beta[j] ~ normal(0, sqrt(1000));
    r[j] ~ gamma(0.001, 0.001);
  }

  for (i in 1:n) {
      if (y[i] == 0)
        target += log_sum_exp(bernoulli_lpmf(1 | p0[gender[i] + 1]),
                              bernoulli_lpmf(0 | p0[gender[i] + 1])
                                + neg_binomial_2_lpmf(y[i] | lambda[i], r[gender[i] + 1]));
      else
        target += bernoulli_lpmf(0 | p0[gender[i] + 1]) + neg_binomial_2_lpmf(y[i] | lambda[i], r[gender[i] + 1]);
  }
}
generated quantities {
  vector[n] yrep;
  vector[n] log_lik;
  vector[2] mu_nb;
  vector[2] v_nb;
  vector[2] mu;
  vector[2] v;
  for(i in 1:n) {
    if(bernoulli_rng(p0[gender[i] + 1])) {
      yrep[i] = 0;
    } else {
      yrep[i] = neg_binomial_2_rng(lambda[i], r[gender[i] + 1]);
    }
    if(y[i] == 0) {
      log_lik[i] = log_sum_exp(bernoulli_lpmf(1 | p0[gender[i] + 1]),
                               bernoulli_lpmf(0 | p0[gender[i] + 1])
                               + neg_binomial_2_lpmf(y[i] | lambda[i], r[gender[i] + 1]));
    } else {
      log_lik[i] = bernoulli_lpmf(0 | p0[gender[i] + 1]) + neg_binomial_2_lpmf(y[i] | lambda[i], r[gender[i] + 1]);
    }
  }
  for(j in 1:2) {
    mu_nb[j] = exp(beta[1] + beta[2] * (j == 2));
    mu[j] = (1 - p0[j]) * mu_nb[j];
    v_nb[j] = mu_nb[j] + mu_nb[j]^2/r[j];
    v[j] = (1 - p0[j]) * (v_nb[j] + p0[j] * mu_nb[j]^2);
  }
}
"

init_fun_zinb_glm = function() { 
  list(beta = rnorm(2), p0 = runif(2), r = runif(2, 0.2, 0.6)) 
} 

library(rstan)
# zinb_glm = stan(model_code = zinb_glm_code, data = gss,
#                 iter = 5e3, seed = 93,
#                 init = init_fun_zinb_glm)
# 
# params_zinb_glm = as.array(zinb_glm,
#                           pars = c("p0", "beta", "mu", "v"))
# save(params_zinb_glm, file = "example_8_3_zinb_glm_params.rda")
load(file = "example_8_3_zinb_glm_params.rda")

# # # summary information
# summary_zinb_glm = summary(zinb_glm,
#                           pars = c("p0", "beta", "mu", "v"))
# save(summary_zinb_glm, file = "example_8_3_zinb_glm_summary.rda")
load(file = "example_8_3_zinb_glm_summary.rda")
summary_zinb_glm$summary

# trace plots
library(bayesplot)
mcmc_trace(params_zinb_glm, regex_pars = c("p0", "beta"))
mcmc_trace(params_zinb_glm, regex_pars = c("mu", "v"))

library(loo)
# ll_zinb_glm = extract_log_lik(zinb_glm, merge_chains = FALSE)
# # compute waic
# waic_zinb_glm = waic(ll_zinb_glm)
# # compute effective sample size of liklihood
# r_eff_zinb_glm = relative_eff(exp(ll_zinb_glm))
# # compute looic (using effective sample size)
# looic_zinb_glm = loo(ll_zinb_glm, r_eff = r_eff_zinb_glm)
# save(waic_zinb_glm, looic_zinb_glm,
#      file = "example_8_3_zinb_glm_ic.rda")
load(file = "example_8_3_zinb_glm_ic.rda")
waic_zinb_glm
looic_zinb_glm

# # extract small subset of yrep
# samples_zinb_glm = extract(zinb_glm)
# s = sample(seq_len(nrow(samples_zinb_glm$log_lik)), 1000)
# yrep_zinb_glm = samples_zinb_glm$yrep[s, ]
# save(yrep_zinb_glm, file = "example_8_3_zinb_glm_yrep.rda")
load(file = "example_8_3_zinb_glm_yrep.rda")

ppc_hist(gss$y, yrep_zinb_glm[1:8, ])
ppc_ecdf_overlay(gss$y, yrep_zinb_glm)
ppc_intervals(gss$y, yrep_zinb_glm)
